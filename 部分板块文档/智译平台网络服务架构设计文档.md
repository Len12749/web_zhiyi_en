# 智译平台网络服务架构设计文档

## 1. 概述

智译平台是一个基于Next.js和多种微服务构建的文档处理服务平台，集成了PDF解析、手写图片识别、文档翻译等多种功能。本文档描述了智译平台的网络服务架构设计，包括前端、后端微服务、数据库以及部署架构。

## 2. 系统架构概览

智译平台采用前后端分离的微服务架构，主要由以下部分组成：

1. **前端应用**：基于Next.js构建的Web应用
2. **后端微服务**：多个独立的Python服务，提供不同的文档处理功能
3. **数据库服务**：PostgreSQL数据库，通过本地Supabase实例部署
4. **认证服务**：Clerk认证系统，提供用户认证和账户管理
5. **反向代理**：Nginx反向代理，用于路由请求和负载均衡

### 2.1 架构图

```
┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │
│   用户浏览器     │────▶│   Nginx反向代理  │
│                 │     │                 │
└─────────────────┘     └────────┬────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│                      Next.js前端应用 (端口3000)                   │
│                                                                 │
└───────┬─────────────┬─────────────┬─────────────┬───────────────┘
        │             │             │             │
        ▼             ▼             ▼             ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│              │ │              │ │              │ │              │
│  PDF解析服务  │ │ 手写图片识别 │ │ Markdown翻译 │ │ PDF保留排版翻译 │
│  (端口8002)  │ │  (端口8004)  │ │  (端口8003)  │ │  (端口8005)  │
│              │ │              │ │              │ │              │
└──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘
        │             │             │             │
        │             │             │             │
        ▼             ▼             ▼             ▼
┌──────────────────────────────────────────────────────────────────┐
│                                                                  │
│             格式转换服务 (端口8001)                               │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
        │
        │
        ▼
┌──────────────────────────────────────────────────────────────────┐
│                                                                  │
│           PostgreSQL数据库 (Supabase本地实例 端口54322)           │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
        │
        │
        ▼
┌──────────────────────────────────────────────────────────────────┐
│                                                                  │
│                     Clerk认证服务 (外部服务)                      │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

## 3. 网络服务组件详解

### 3.1 前端应用 (Next.js)

- **端口**: 3000
- **技术栈**: Next.js 15, React, TypeScript, Tailwind CSS
- **功能**: 提供用户界面，处理用户请求，与后端微服务通信
- **特点**:
  - 基于App Router架构
  - 使用Server-Sent Events (SSE)进行实时状态更新
  - 集成Clerk认证系统
  - 使用Drizzle ORM进行数据库操作

### 3.2 后端微服务

#### 3.2.1 PDF解析服务

- **端口**: 8002
- **技术栈**: Python, FastAPI, Uvicorn
- **功能**: 将PDF文件解析为Markdown格式
- **依赖环境**: Conda环境 - docling

#### 3.2.2 手写图片识别服务

- **端口**: 8004
- **技术栈**: Python, FastAPI, Uvicorn
- **功能**: 将图片内容识别并转换为Markdown文本
- **依赖环境**: Conda环境 - docling

#### 3.2.3 Markdown翻译服务

- **端口**: 8003
- **技术栈**: Python, FastAPI, Uvicorn
- **功能**: 翻译Markdown文件，保留原格式
- **依赖环境**: Conda环境 - docling

#### 3.2.4 PDF保留排版翻译服务

- **端口**: 8005
- **技术栈**: Python, FastAPI, Uvicorn
- **功能**: 翻译PDF文件，保留原排版
- **依赖环境**: Conda环境 - test

#### 3.2.5 格式转换服务

- **端口**: 8001
- **技术栈**: Python, FastAPI, Uvicorn
- **功能**: 将Markdown转换为其他格式(Word, PDF, HTML, LaTeX)
- **依赖环境**: Conda环境 - docling

### 3.3 数据库服务

- **端口**: 54322
- **技术栈**: PostgreSQL (通过本地Supabase Docker实例)
- **功能**: 存储用户数据、任务信息、积分记录等
- **连接**: 通过Drizzle ORM进行操作

### 3.4 认证服务

- **技术栈**: Clerk认证系统
- **功能**: 提供用户注册、登录、密码重置等功能
- **特点**: 外部云服务，通过API集成

### 3.5 反向代理 (Nginx)

- **功能**:
  - 路由请求到相应的服务
  - 提供SSL终止
  - 负载均衡
  - 静态资源缓存
  - 请求限流

## 4. 网络通信流程

### 4.1 用户认证流程

1. 用户访问智译平台
2. 前端应用通过Clerk SDK验证用户认证状态
3. 如未登录，重定向至登录页面
4. 用户登录后，Clerk返回认证令牌
5. 前端应用存储令牌并初始化用户状态
6. 前端应用通过API调用后端服务

### 4.2 文档处理流程

1. 用户上传文件并选择处理选项
2. 前端应用将文件发送至相应的API端点
3. Next.js API路由接收请求并验证用户权限
4. API路由将请求转发至相应的微服务
5. 微服务处理文件并返回任务ID
6. 前端应用通过SSE连接实时监控任务进度
7. 任务完成后，前端应用提供下载链接

### 4.3 SSE实时通信流程

1. 用户发起文档处理任务
2. 前端应用建立SSE连接 `/api/sse/tasks/{taskId}`
3. 后端服务处理文件并实时推送进度更新
4. 前端应用接收事件并更新UI显示进度
5. 任务完成后，前端接收完成事件并提供下载选项
