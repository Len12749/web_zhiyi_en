---
description: "æ™ºè¯‘å¹³å°å¼€å‘è§„èŒƒ"
globs: ["**/*"]
alwaysApply: true
---



# æ™ºè¯‘å¹³å°å¼€å‘è§„èŒƒ (.cursorrules)

åŸºäº Next.js 15 + SSE å¼‚æ­¥æ¶æ„çš„æ–‡æ¡£å¤„ç†æœåŠ¡å¹³å°ï¼Œä½¿ç”¨ TypeScript å¼€å‘ï¼Œé›†æˆ Clerk è®¤è¯ç³»ç»Ÿã€‚

é‡è¦ï¼šä»»ä½•ç¼–ç å¼€å§‹é’±éƒ½è¦å…ˆç†è§£ç°æœ‰ä»£ç çš„æ–‡ä»¶ç»“æ„ååœ¨åˆç†ä½ç½®è¿›è¡Œç¼–ç ï¼Œæœç»å•çº¯çš„å¢é‡å¼€å‘ã€‚

## æ ¸å¿ƒæ¶æ„åŸåˆ™

### SSE å¼‚æ­¥æ¶æ„

- **æ‰€æœ‰ä¸šåŠ¡æ“ä½œ**å¿…é¡»ä½¿ç”¨ Server-Sent Events (SSE) å®ç°å®æ—¶åé¦ˆ
- **ç¦æ­¢è½®è¯¢**ï¼šä¸å…è®¸ä½¿ç”¨ setInterval æˆ– setTimeout è¿›è¡ŒçŠ¶æ€è½®è¯¢
- **ä»»åŠ¡é©±åŠ¨**ï¼šæ‰€æœ‰æ–‡ä»¶å¤„ç†æ“ä½œéƒ½å¿…é¡»åˆ›å»º processing_tasks è®°å½•å¹¶é€šè¿‡ SSE æ¨é€çŠ¶æ€
- **SSEè¿æ¥æ˜¯ä¸´æ—¶çš„æŠ€æœ¯å®ç°**ï¼Œä¸åº”è¯¥æŒä¹…åŒ–åˆ°æ•°æ®åº“
- **è¿æ¥ç®¡ç†å±äºå†…å­˜æ“ä½œ**ï¼Œåº”è¯¥ç”¨Mapç­‰æ•°æ®ç»“æ„ç®¡ç†
- **ä»»åŠ¡æ¨é€åªéœ€è¦ç”¨æˆ·ID+ä»»åŠ¡ID**ï¼Œä¸éœ€è¦å•ç‹¬çš„è¿æ¥è¡¨

### å‰åç«¯åˆ†ç¦»

- **å‰ç«¯é€»è¾‘**ï¼šæ”¾åœ¨ `app/` ç›®å½•ä¸‹ï¼ŒåŒ…å«é¡µé¢ã€ç»„ä»¶ã€API è·¯ç”±
- **åç«¯é€»è¾‘**ï¼šæ”¾åœ¨ `actions/` ç›®å½•ä¸‹ï¼ŒåŒ…å«æ•°æ®åº“æ“ä½œã€ä¸šåŠ¡é€»è¾‘å°è£…
- **å·¥å…·å‡½æ•°**ï¼šæ”¾åœ¨ `lib/` ç›®å½•ä¸‹ï¼ŒåŒ…å«å¯å¤ç”¨çš„å·¥å…·å’Œ hooks
- æ‰€æœ‰æ•°æ®åº“æ“ä½œæ”¾åœ¨ `db/` ç›®å½•ï¼Œä½¿ç”¨ Drizzle ORM

### é¡¹ç›®ç»“æ„

```
web/
â”œâ”€â”€ actions/                          # åç«¯ä¸šåŠ¡é€»è¾‘ï¼ˆå¿…é¡»ï¼‰
â”‚   â”œâ”€â”€ auth/                        # ç”¨æˆ·è®¤è¯ç›¸å…³æ“ä½œ
â”‚   â”œâ”€â”€ files/                       # æ–‡ä»¶ç®¡ç†æ“ä½œ
â”‚   â”œâ”€â”€ tasks/                       # ä»»åŠ¡ç®¡ç†æ“ä½œ
â”‚   â”œâ”€â”€ points/                      # ç§¯åˆ†ç›¸å…³æ“ä½œ
â”‚   â””â”€â”€ notifications/               # é€šçŸ¥ç›¸å…³æ“ä½œ
â”‚
â”œâ”€â”€ app/                             # å‰ç«¯åº”ç”¨ï¼ˆNext.js App Routerï¼‰
â”‚   â”œâ”€â”€ (auth)/                      # è®¤è¯ç›¸å…³é¡µé¢
â”‚   â”œâ”€â”€ api/                         # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ sse/                     # SSE è¿æ¥ç«¯ç‚¹
â”‚   â”‚   â”œâ”€â”€ tasks/                   # ä»»åŠ¡ç›¸å…³ API
â”‚   â”‚   â”œâ”€â”€ files/                   # æ–‡ä»¶ç›¸å…³ API
â”‚   â”‚   â””â”€â”€ user/                    # ç”¨æˆ·ç›¸å…³ API
â”‚   â”œâ”€â”€ [åŠŸèƒ½æ¨¡å—]/                   # å„åŠŸèƒ½é¡µé¢
â”‚   â”‚   â”œâ”€â”€ page.tsx                 # é¡µé¢ç»„ä»¶
â”‚   â”‚   â””â”€â”€ _components/             # é¡µé¢ä¸“ç”¨ç»„ä»¶
â”‚   â”œâ”€â”€ globals.css
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”‚
â”œâ”€â”€ components/                      # å…¨å±€å…±äº«ç»„ä»¶
â”‚   â”œâ”€â”€ ui/                         # åŸºç¡€ UI ç»„ä»¶
â”‚   â”œâ”€â”€ layout/                     # å¸ƒå±€ç»„ä»¶
â”‚   â”œâ”€â”€ common/                     # é€šç”¨ä¸šåŠ¡ç»„ä»¶
â”‚   â””â”€â”€ providers/                  # å…¨å±€ Provider
â”‚
â”œâ”€â”€ db/                             # æ•°æ®åº“ç›¸å…³ï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰
â”‚   â”œâ”€â”€ migrations/                 # æ•°æ®åº“è¿ç§»æ–‡ä»¶
â”‚   â”œâ”€â”€ schema/                     # å­˜æ”¾æ•°æ®åº“æ¨¡å¼å®šä¹‰æ–‡ä»¶
â”‚   â”œâ”€â”€ index.ts                    # æ•°æ®åº“è¿æ¥å’ŒåŸºç¡€æ“ä½œ
â”‚   â””â”€â”€ queries/                    # å¤æ‚æŸ¥è¯¢å°è£…
â”‚
â”œâ”€â”€ lib/                            # å·¥å…·å‡½æ•°å’Œé…ç½®
â”‚   â”œâ”€â”€ hooks/                      # è‡ªå®šä¹‰ React hooks
â”‚   â”œâ”€â”€ sse/                        # SSE ç›¸å…³å·¥å…·
â”‚   â”œâ”€â”€ processing/                 # æ–‡ä»¶å¤„ç†ç›¸å…³å·¥å…·
â”‚   â”œâ”€â”€ external/                   # å¤–éƒ¨æœåŠ¡é›†æˆ
â”‚   â”œâ”€â”€ utils.ts                    # é€šç”¨å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ config.ts                   # åº”ç”¨é…ç½®
â”‚   â””â”€â”€ constants.ts                # å¸¸é‡å®šä¹‰
â”‚
â”œâ”€â”€ public/                         # é™æ€èµ„æº
â”œâ”€â”€ types/                          # TypeScript ç±»å‹å®šä¹‰
â””â”€â”€ é…ç½®æ–‡ä»¶ï¼ˆæ ¹ç›®å½•ï¼‰
```



### âŒ ç»å¯¹ç¦æ­¢

1. **src/ æ–‡ä»¶å¤¹**ï¼šä¸å…è®¸ä½¿ç”¨ src åŒ…è£…ï¼Œç›´æ¥ä½¿ç”¨ app/, actions/, lib/ ç­‰
2. **æ··åˆè¯­è¨€**ï¼šç¦æ­¢åœ¨é¡¹ç›®ä¸­å‡ºç° Pythonã€PHP ç­‰å…¶ä»–è¯­è¨€è„šæœ¬
3. **æ•°æ®åº“æ–‡ä»¶æ•£å¸ƒ**ï¼šç¦æ­¢åœ¨æ ¹ç›®å½•æ”¾ç½®æ•°æ®åº“æ“ä½œæ–‡ä»¶
4. **ç›´æ¥æ•°æ®åº“æ“ä½œ**ï¼šç¦æ­¢åœ¨é¡µé¢ç»„ä»¶ä¸­ç›´æ¥è°ƒç”¨æ•°æ®åº“

## å¼€å‘è§„èŒƒ

### æ–‡ä»¶å‘½åè§„èŒƒ

#### Actions æ–‡ä»¶å‘½å

```
actions/
â”œâ”€â”€ auth/user-actions.ts           # ç”¨æˆ·æ“ä½œ
â”œâ”€â”€ files/file-actions.ts          # æ–‡ä»¶æ“ä½œ
â”œâ”€â”€ tasks/task-actions.ts          # ä»»åŠ¡æ“ä½œ
â”œâ”€â”€ tasks/processing-actions.ts    # å¤„ç†æ“ä½œ
â””â”€â”€ points/point-actions.ts        # ç§¯åˆ†æ“ä½œ
```

#### ç»„ä»¶æ–‡ä»¶å‘½å

```
app/pdf-to-markdown/
â”œâ”€â”€ page.tsx                       # é¡µé¢ç»„ä»¶
â””â”€â”€ _components/                   # é¡µé¢ä¸“ç”¨ç»„ä»¶
    â”œâ”€â”€ upload-zone.tsx            # kebab-case
    â”œâ”€â”€ processing-status.tsx      # kebab-case
    â””â”€â”€ result-display.tsx         # kebab-case

components/
â”œâ”€â”€ ui/button.tsx                  # åŸºç¡€ç»„ä»¶ kebab-case
â”œâ”€â”€ common/file-upload-zone.tsx    # é€šç”¨ç»„ä»¶ kebab-case
â””â”€â”€ providers/sse-provider.tsx     # Provider kebab-case
```

#### API è·¯ç”±å‘½å

```
app/api/
â”œâ”€â”€ sse/tasks/[taskId]/route.ts    # SSE ç«¯ç‚¹
â”œâ”€â”€ tasks/create/route.ts          # ä»»åŠ¡åˆ›å»º
â”œâ”€â”€ tasks/[taskId]/route.ts        # ä»»åŠ¡è¯¦æƒ…
â”œâ”€â”€ files/upload/route.ts          # æ–‡ä»¶ä¸Šä¼ 
â””â”€â”€ user/points/route.ts           # ç”¨æˆ·ç§¯åˆ†
```



#### ç¯å¢ƒå˜é‡é…ç½®

```bash
# æ•°æ®å­˜å‚¨è·¯å¾„ï¼ˆé¡¹ç›®å¤–ï¼‰
DATA_STORAGE_PATH=""

# åç«¯ä¸šåŠ¡ç«¯å£
......


# æ•°æ®åº“è¿æ¥URL - æœ¬åœ°Supabaseå®ä¾‹
DATABASE_URL=postgresql://postgres:postgres@127.0.0.1:54322/postgres

# Clerkè®¤è¯å¯†é’¥ 
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_d2hvbGUtYmFkZ2VyLTQ0LmNsZXJrLmFjY291bnRzLmRldiQ
CLERK_SECRET_KEY=sk_test_V7jMW0scmVZa8MMFdCis97Bzqjx38RL99TnWoZ2maa

# Clerké‡å®šå‘URL
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/login
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/signup
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/dashboard
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/dashboard

# Supabaseæœ¬åœ°å¯†é’¥
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU
SUPABASE_URL=http://127.0.0.1:54321
```



### ç”¨æˆ·æ–‡ä»¶æ•°æ®å­˜å‚¨ç»“æ„

```
${DATA_STORAGE_PATH}/
â”œâ”€â”€ uploads/                       # ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶
â”‚   â””â”€â”€ [user_id]/
â”‚       â””â”€â”€ [business_type]/       # ä¸šåŠ¡ç±»å‹åˆ†ç±»
â”‚           â””â”€â”€ [date]/            # æ—¥æœŸåˆ†ç±»
â”‚               â””â”€â”€ [task_id]/     # ä»»åŠ¡IDåˆ†ç±»
â”‚                   â”œâ”€â”€ original/  # åŸå§‹æ–‡ä»¶
â”‚                   â””â”€â”€ metadata.json # å…ƒæ•°æ®æ–‡ä»¶
â”‚
â”œâ”€â”€ processed/                     # å¤„ç†ç»“æœæ–‡ä»¶
â”‚   â””â”€â”€ [user_id]/
â”‚       â””â”€â”€ [business_type]/       # ä¸šåŠ¡ç±»å‹åˆ†ç±»
â”‚           â””â”€â”€ [task_id]/         # ä»»åŠ¡ç»“æœ
â”‚               â”œâ”€â”€ result/        # å¤„ç†ç»“æœæ–‡ä»¶
â”‚               â”œâ”€â”€ intermediate/  # ä¸­é—´æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
â”‚               â””â”€â”€ metadata.json  # ç»“æœå…ƒæ•°æ®
â”‚
â”œâ”€â”€ temp/                         # ä¸´æ—¶å¤„ç†æ–‡ä»¶
â”‚   â””â”€â”€ [task_id]/                # æŒ‰ä»»åŠ¡åˆ†ç±»
â”‚       â”œâ”€â”€ working/              # å·¥ä½œç›®å½•
â”‚       â””â”€â”€ cache/                # ç¼“å­˜æ–‡ä»¶
â”‚
â””â”€â”€ archive/                      # å½’æ¡£æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
    â””â”€â”€ [user_id]/
        â””â”€â”€ [business_type]/
            â””â”€â”€ [year]/
                â””â”€â”€ [month]/

# ä¸šåŠ¡ç±»å‹åˆ†ç±»ï¼š
# - pdf-to-markdown    : PDFè§£æè½¬Markdown
# - translation        : æ–‡æ¡£ç¿»è¯‘
# - image-to-markdown  : å›¾ç‰‡è½¬Markdown  
# - format-conversion  : æ ¼å¼è½¬æ¢
# - preserve-layout-translation : PDFä¿ç•™æ’ç‰ˆç¿»è¯‘
```

### æ ¸å¿ƒæ•°æ®è¡¨ç»“æ„

```sql
-- 1. ç”¨æˆ·è¡¨
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    clerk_id VARCHAR(255) UNIQUE NOT NULL,
    email VARCHAR(255) NOT NULL,
    points INTEGER DEFAULT 20 NOT NULL,
    has_infinite_points BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 2. å¤„ç†ä»»åŠ¡è¡¨
CREATE TABLE processing_tasks (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    
    -- ä»»åŠ¡ä¿¡æ¯
    task_type VARCHAR(50) NOT NULL, -- pdf_to_markdown, translation, etc.
    task_status VARCHAR(20) DEFAULT 'pending' NOT NULL, -- pending, processing, completed, failed
    progress_percent INTEGER DEFAULT 0,
    status_message TEXT,
    
    -- è¾“å…¥æ–‡ä»¶
    input_filename VARCHAR(255) NOT NULL,
    input_file_size BIGINT NOT NULL,
    input_storage_path VARCHAR(500) NOT NULL, -- å¤–éƒ¨å­˜å‚¨è·¯å¾„
    
    -- å¤„ç†å‚æ•°
    processing_params JSONB DEFAULT '{}',
    
    -- å¤–éƒ¨æœåŠ¡
    external_task_id VARCHAR(255),
    
    -- ç§¯åˆ†
    estimated_points INTEGER DEFAULT 0,
    actual_points_used INTEGER DEFAULT 0,
    
    -- ç»“æœ
    result_storage_path VARCHAR(500),
    result_file_size BIGINT,
    result_filename VARCHAR(255), -- ä¾›ä¸‹è½½çš„æ–‡ä»¶å
    
    -- é”™è¯¯å¤„ç†
    error_code VARCHAR(50),
    error_message TEXT,
    retry_count INTEGER DEFAULT 0,
    
    -- æ—¶é—´ç®¡ç†
    created_at TIMESTAMP DEFAULT NOW(),
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    expires_at TIMESTAMP DEFAULT (NOW() + INTERVAL '7 days'),
    
    FOREIGN KEY (user_id) REFERENCES users(clerk_id) ON DELETE CASCADE
);

-- 3. ç§¯åˆ†äº¤æ˜“è¡¨
CREATE TABLE point_transactions (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    task_id INTEGER,
    amount INTEGER NOT NULL,
    transaction_type VARCHAR(50) NOT NULL,
    description TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    
    FOREIGN KEY (user_id) REFERENCES users(clerk_id) ON DELETE CASCADE,
    FOREIGN KEY (task_id) REFERENCES processing_tasks(id) ON DELETE SET NULL
);

-- 4. ç”¨æˆ·ç­¾åˆ°è¡¨
CREATE TABLE user_checkins (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    checkin_date DATE NOT NULL,
    points_earned INTEGER DEFAULT 1,
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(user_id, checkin_date),
    FOREIGN KEY (user_id) REFERENCES users(clerk_id) ON DELETE CASCADE
);

-- 5. å…‘æ¢ç è¡¨
CREATE TABLE redeem_codes (
    id SERIAL PRIMARY KEY,
    code VARCHAR(50) UNIQUE NOT NULL,
    points_value INTEGER NOT NULL,
    max_uses INTEGER,
    current_uses INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    expires_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);
-- 6. å…‘æ¢è®°å½•è¡¨
CREATE TABLE code_redemptions (
    id SERIAL PRIMARY KEY,
    code_id INTEGER NOT NULL,
    user_id VARCHAR(255) NOT NULL,
    points_earned INTEGER NOT NULL,
    transaction_id INTEGER,
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(code_id, user_id),
    FOREIGN KEY (code_id) REFERENCES redeem_codes(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(clerk_id) ON DELETE CASCADE,
    FOREIGN KEY (transaction_id) REFERENCES point_transactions(id)
);
```

## ä¸»è¦æ¶æ„/å…³ç³»å›¾



### ç”¨æˆ·è®¤è¯å’Œåˆå§‹åŒ–æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Clerk as Clerkè®¤è¯
    participant Frontend as å‰ç«¯åº”ç”¨
    participant InitAPI as ç”¨æˆ·åˆå§‹åŒ–API
    participant DB as æ•°æ®åº“

    User->>Clerk: è®¿é—®åº”ç”¨/ç™»å½•
    Clerk->>Frontend: ç”¨æˆ·è®¤è¯çŠ¶æ€
    
    alt ç”¨æˆ·å·²ç™»å½•
        Frontend->>InitAPI: POST /api/user/init<br/>{clerkId, email}
        InitAPI->>DB: æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        
        alt ç”¨æˆ·ä¸å­˜åœ¨
            InitAPI->>DB: åˆ›å»ºç”¨æˆ·è®°å½•<br/>åˆå§‹ç§¯åˆ†20
            InitAPI->>DB: è®°å½•ç§¯åˆ†äº¤æ˜“<br/>INITIALç±»å‹
            InitAPI->>DB: è®°å½•æ´»åŠ¨æ—¥å¿—<br/>"ç”¨æˆ·æ³¨å†Œ"
            InitAPI->>Frontend: 201 - ç”¨æˆ·åˆ›å»ºæˆåŠŸ
        else ç”¨æˆ·å·²å­˜åœ¨
            InitAPI->>Frontend: 200 - ç”¨æˆ·å·²å­˜åœ¨
        end
        
        Frontend->>User: æ˜¾ç¤ºä¸ªäººä¸­å¿ƒ/åº”ç”¨ä¸»é¡µ
    else ç”¨æˆ·æœªç™»å½•
        Frontend->>User: é‡å®šå‘åˆ°ç™»å½•é¡µé¢
        User->>Clerk: è¿›è¡Œç™»å½•/æ³¨å†Œ
        Clerk->>Frontend: è®¤è¯æˆåŠŸ
        Frontend->>InitAPI: è‡ªåŠ¨åˆå§‹åŒ–ç”¨æˆ·
    end
```





### åŸºäºSSEçš„æ–‡æ¡£å¤„ç†æœåŠ¡é€šç”¨æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Frontend as å‰ç«¯
    participant TaskAPI as ä»»åŠ¡åˆ›å»ºAPI
    participant SSEAPI as SSEè¿æ¥API
    participant SSEManager as SSEè¿æ¥ç®¡ç†å™¨<br/>(å†…å­˜)
    participant TaskProcessor as ä»»åŠ¡å¤„ç†å™¨
    participant ExternalService as å¤–éƒ¨å¤„ç†æœåŠ¡
    participant Storage as å¤–éƒ¨æ–‡ä»¶å­˜å‚¨
    participant DB as æ•°æ®åº“

    User->>Frontend: ä¸Šä¼ æ–‡ä»¶+å¤„ç†å‚æ•°
    Frontend->>TaskAPI: POST /api/tasks/create
    
    TaskAPI->>DB: éªŒè¯ç”¨æˆ·ç§¯åˆ†
    alt ç§¯åˆ†ä¸è¶³
        TaskAPI->>Frontend: 402 - ç§¯åˆ†ä¸è¶³
        Frontend->>User: æ˜¾ç¤ºç§¯åˆ†ä¸è¶³æç¤º
    else ç§¯åˆ†å……è¶³
        TaskAPI->>Storage: ä¿å­˜è¾“å…¥æ–‡ä»¶
        TaskAPI->>DB: åˆ›å»ºprocessing_tasksè®°å½•<br/>status: pending
        TaskAPI->>TaskProcessor: å¼‚æ­¥å¯åŠ¨å¤„ç† (ä¸ç­‰å¾…)
        TaskAPI->>Frontend: 200 - è¿”å›taskIdå’ŒsseUrl
        
        Frontend->>SSEAPI: GET /api/sse/tasks/{taskId}
        SSEAPI->>DB: éªŒè¯ä»»åŠ¡å½’å±æƒé™
        SSEAPI->>SSEManager: æ³¨å†ŒSSEè¿æ¥
        SSEAPI->>Frontend: å»ºç«‹SSEæµè¿æ¥
        SSEManager->>Frontend: æ¨é€å½“å‰ä»»åŠ¡çŠ¶æ€
        
        par å¼‚æ­¥ä»»åŠ¡å¤„ç†
            TaskProcessor->>DB: æ›´æ–°çŠ¶æ€: processing
            TaskProcessor->>SSEManager: æ¨é€çŠ¶æ€æ›´æ–°äº‹ä»¶
            SSEManager->>Frontend: SSEæ¨é€: å¤„ç†å¼€å§‹
            
            TaskProcessor->>ExternalService: è°ƒç”¨å¤–éƒ¨å¤„ç†æœåŠ¡
            ExternalService->>TaskProcessor: è¿”å›å¤„ç†ç»“æœæˆ–taskId
            
            alt éœ€è¦ç›‘æ§å¤–éƒ¨ä»»åŠ¡
                loop çŠ¶æ€ç›‘æ§
                    TaskProcessor->>ExternalService: æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
                    TaskProcessor->>SSEManager: æ¨é€è¿›åº¦æ›´æ–°
                    SSEManager->>Frontend: SSEæ¨é€: è¿›åº¦æ›´æ–°
                end
            end
            
            alt å¤„ç†æˆåŠŸ
                TaskProcessor->>Storage: ä¿å­˜ç»“æœæ–‡ä»¶
                TaskProcessor->>DB: æ›´æ–°ä»»åŠ¡çŠ¶æ€: completed<br/>æ‰£é™¤ç§¯åˆ†
                TaskProcessor->>SSEManager: æ¨é€å®Œæˆäº‹ä»¶
                SSEManager->>Frontend: SSEæ¨é€: ä»»åŠ¡å®Œæˆ+ä¸‹è½½URL
                Frontend->>User: æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
            else å¤„ç†å¤±è´¥
                TaskProcessor->>DB: æ›´æ–°ä»»åŠ¡çŠ¶æ€: failed<br/>è¿”è¿˜ç§¯åˆ†(å¦‚å·²æ‰£é™¤)
                TaskProcessor->>SSEManager: æ¨é€å¤±è´¥äº‹ä»¶
                SSEManager->>Frontend: SSEæ¨é€: ä»»åŠ¡å¤±è´¥+é”™è¯¯ä¿¡æ¯
                Frontend->>User: æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            end
        end
        
        User->>Frontend: ç‚¹å‡»ä¸‹è½½
        Frontend->>TaskAPI: GET /api/tasks/{taskId}/download
        TaskAPI->>Storage: è·å–ç»“æœæ–‡ä»¶
        TaskAPI->>User: è¿”å›æ–‡ä»¶æµ
    end
```





### ç§¯åˆ†ç³»ç»Ÿå®Œæ•´æµç¨‹

```mermaid
flowchart TD
    Start([ç”¨æˆ·æ“ä½œ]) --> CheckAction{æ“ä½œç±»å‹}
    
    %% ç§¯åˆ†æ¶ˆè´¹æµç¨‹
    CheckAction -->|æ–‡æ¡£å¤„ç†| ConsumeFlow[ç§¯åˆ†æ¶ˆè´¹æµç¨‹]
    ConsumeFlow --> CalcPoints[è®¡ç®—æ‰€éœ€ç§¯åˆ†<br/>- PDFè§£æ: 2ç§¯åˆ†/é¡µ<br/>- ç¿»è¯‘: 1ç§¯åˆ†/åƒå­—ç¬¦<br/>- æ ¼å¼è½¬æ¢: 1ç§¯åˆ†/æ–‡ä»¶<br/>- å›¾ç‰‡è¯†åˆ«: 2ç§¯åˆ†/å›¾ç‰‡<br/>- PDFä¿ç•™æ’ç‰ˆç¿»è¯‘: 3ç§¯åˆ†/é¡µ]
    CalcPoints --> CheckBalance{æ£€æŸ¥ç§¯åˆ†ä½™é¢}
    CheckBalance -->|ç§¯åˆ†ä¸è¶³| InsufficientPoints[è¿”å›ç§¯åˆ†ä¸è¶³é”™è¯¯]
    CheckBalance -->|ç§¯åˆ†å……è¶³| DeductPoints[æ‰£é™¤ç§¯åˆ†<br/>è®°å½•äº¤æ˜“]
    DeductPoints --> ProcessTask[æ‰§è¡Œä»»åŠ¡]
    ProcessTask --> TaskResult{ä»»åŠ¡ç»“æœ}
    TaskResult -->|æˆåŠŸ| TaskSuccess[ä»»åŠ¡å®Œæˆ<br/>ç§¯åˆ†å·²æ¶ˆè´¹]
    TaskResult -->|å¤±è´¥| RefundPoints[è¿”è¿˜ç§¯åˆ†<br/>è®°å½•è¿”è¿˜äº¤æ˜“]
    
    %% ç§¯åˆ†è·å¾—æµç¨‹
    CheckAction -->|æ¯æ—¥ç­¾åˆ°| CheckinFlow[ç­¾åˆ°æµç¨‹]
    CheckinFlow --> CheckToday{ä»Šæ—¥æ˜¯å¦å·²ç­¾åˆ°}
    CheckToday -->|å·²ç­¾åˆ°| AlreadyChecked[è¿”å›å·²ç­¾åˆ°æç¤º]
    CheckToday -->|æœªç­¾åˆ°| DoCheckin[æ‰§è¡Œç­¾åˆ°<br/>+1ç§¯åˆ†]
    DoCheckin --> RecordCheckin[è®°å½•ç­¾åˆ°è®°å½•<br/>è®°å½•ç§¯åˆ†äº¤æ˜“]
    RecordCheckin --> CheckinSuccess[ç­¾åˆ°æˆåŠŸ]
    
    CheckAction -->|å…‘æ¢ç å…‘æ¢| RedeemFlow[å…‘æ¢ç æµç¨‹]
    RedeemFlow --> ValidateCode{éªŒè¯å…‘æ¢ç }
    ValidateCode -->|æ— æ•ˆ| InvalidCode[è¿”å›å…‘æ¢ç æ— æ•ˆ]
    ValidateCode -->|æœ‰æ•ˆ| CheckCodeUsage{æ£€æŸ¥ä½¿ç”¨é™åˆ¶}
    CheckCodeUsage -->|å·²è¾¾ä¸Šé™| CodeLimitReached[è¿”å›ä½¿ç”¨æ¬¡æ•°é™åˆ¶]
    CheckCodeUsage -->|å¯ä½¿ç”¨| AddPoints[å¢åŠ ç§¯åˆ†<br/>è®°å½•å…‘æ¢è®°å½•]
    AddPoints --> RedeemSuccess[å…‘æ¢æˆåŠŸ]
    
    CheckAction -->|æ–°ç”¨æˆ·æ³¨å†Œ| RegisterFlow[æ³¨å†Œæµç¨‹]
    RegisterFlow --> CreateUser[åˆ›å»ºç”¨æˆ·<br/>åˆå§‹20ç§¯åˆ†]
    CreateUser --> InitialTransaction[è®°å½•åˆå§‹ç§¯åˆ†äº¤æ˜“<br/>INITIALç±»å‹]
    InitialTransaction --> RegisterSuccess[æ³¨å†Œå®Œæˆ]
    
    %% ç§¯åˆ†æŸ¥è¯¢
    CheckAction -->|æŸ¥è¯¢ç§¯åˆ†| QueryFlow[ç§¯åˆ†æŸ¥è¯¢]
    QueryFlow --> GetUserPoints[è·å–ç”¨æˆ·ç§¯åˆ†ä½™é¢]
    GetUserPoints --> GetTransactions[è·å–äº¤æ˜“è®°å½•]
    GetTransactions --> GetActivities[è·å–æ´»åŠ¨è®°å½•]
    GetActivities --> ReturnPointsInfo[è¿”å›ç§¯åˆ†ä¿¡æ¯]
    
    %% æ ·å¼è®¾ç½®
    classDef processStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef decisionStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef successStyle fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef errorStyle fill:#ffebee,stroke:#c62828,stroke-width:2px
    
    class ConsumeFlow,CheckinFlow,RedeemFlow,RegisterFlow,QueryFlow processStyle
    class CheckAction,CheckBalance,CheckToday,ValidateCode,CheckCodeUsage,TaskResult decisionStyle
    class TaskSuccess,CheckinSuccess,RedeemSuccess,RegisterSuccess,ReturnPointsInfo successStyle
    class InsufficientPoints,AlreadyChecked,InvalidCode,CodeLimitReached,RefundPoints errorStyle
```





### æ–‡ä»¶ç®¡ç†ç”Ÿå‘½å‘¨æœŸæµç¨‹

```mermaid
flowchart TD
    Upload([æ–‡ä»¶ä¸Šä¼ ]) --> Validate{æ–‡ä»¶éªŒè¯}
    Validate -->|æ ¼å¼é”™è¯¯| FormatError[è¿”å›æ ¼å¼é”™è¯¯]
    Validate -->|å¤§å°è¶…é™| SizeError[è¿”å›å¤§å°è¶…é™é”™è¯¯]
    Validate -->|éªŒè¯é€šè¿‡| SaveToStorage[ä¿å­˜åˆ°å¤–éƒ¨å­˜å‚¨<br/>ç”Ÿæˆå­˜å‚¨è·¯å¾„]
    
    SaveToStorage --> CreateTask[åˆ›å»ºprocessing_tasksè®°å½•<br/>çŠ¶æ€: pending]
    CreateTask --> ProcessingStates{ä»»åŠ¡å¤„ç†çŠ¶æ€}
    
    ProcessingStates -->|å¤„ç†ä¸­| Processing[çŠ¶æ€: processing<br/>è¿›åº¦: 0-99%]
    Processing --> Monitor[SSEçŠ¶æ€ç›‘æ§]
    Monitor --> ProcessingStates
    
    ProcessingStates -->|å¤„ç†å®Œæˆ| Completed[çŠ¶æ€: completed<br/>ä¿å­˜ç»“æœæ–‡ä»¶è·¯å¾„]
    Completed --> Available[æ–‡ä»¶å¯ä¸‹è½½<br/>æœ‰æ•ˆæœŸ7å¤©]
    
    ProcessingStates -->|å¤„ç†å¤±è´¥| Failed[çŠ¶æ€: failed<br/>è®°å½•é”™è¯¯ä¿¡æ¯]
    Failed --> CleanupFailed[æ¸…ç†å¤±è´¥æ–‡ä»¶]
    
    Available --> DownloadReq{ä¸‹è½½è¯·æ±‚}
    DownloadReq -->|ç”¨æˆ·ä¸‹è½½| AuthCheck{æƒé™éªŒè¯}
    AuthCheck -->|æ— æƒé™| AccessDenied[è¿”å›403é”™è¯¯]
    AuthCheck -->|æœ‰æƒé™| ServeFile[ä»å­˜å‚¨è·å–æ–‡ä»¶<br/>è¿”å›æ–‡ä»¶æµ]
    ServeFile --> LogAccess[è®°å½•ä¸‹è½½æ—¥å¿—]
    
    DownloadReq -->|æ–‡ä»¶è¿‡æœŸ| ExpiredCheck{æ£€æŸ¥è¿‡æœŸæ—¶é—´}
    ExpiredCheck -->|å·²è¿‡æœŸ| CleanupExpired[æ¸…ç†è¿‡æœŸæ–‡ä»¶<br/>åˆ é™¤å­˜å‚¨æ–‡ä»¶]
    ExpiredCheck -->|æœªè¿‡æœŸ| ServeFile
    
    Available --> HistoryQuery[æ–‡ä»¶å†å²æŸ¥è¯¢]
    HistoryQuery --> FilterFiles[æŒ‰ç”¨æˆ·è¿‡æ»¤<br/>æŒ‰æ—¶é—´æ’åº]
    FilterFiles --> FormatResponse[æ ¼å¼åŒ–æ–‡ä»¶ä¿¡æ¯<br/>çŠ¶æ€æ˜ å°„]
    FormatResponse --> ReturnHistory[è¿”å›æ–‡ä»¶å†å²]
    
    Available --> DeleteReq{åˆ é™¤è¯·æ±‚}
    DeleteReq --> DeleteAuth{åˆ é™¤æƒé™éªŒè¯}
    DeleteAuth -->|æ— æƒé™| DeleteDenied[è¿”å›åˆ é™¤æƒé™é”™è¯¯]
    DeleteAuth -->|æœ‰æƒé™| DeleteRecord[åˆ é™¤æ•°æ®åº“è®°å½•]
    DeleteRecord --> DeleteStorage[åˆ é™¤å­˜å‚¨æ–‡ä»¶]
    DeleteStorage --> DeleteSuccess[åˆ é™¤æˆåŠŸ]
    
    %% åå°æ¸…ç†ä»»åŠ¡
    CleanupExpired --> ScheduledCleanup[å®šæ—¶æ¸…ç†ä»»åŠ¡]
    ScheduledCleanup --> ScanExpired[æ‰«æè¿‡æœŸæ–‡ä»¶]
    ScanExpired --> BatchDelete[æ‰¹é‡åˆ é™¤è¿‡æœŸæ–‡ä»¶]
    
    %% æ ·å¼è®¾ç½®
    classDef processStyle fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef decisionStyle fill:#fff8e1,stroke:#ff8f00,stroke-width:2px
    classDef successStyle fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef errorStyle fill:#ffebee,stroke:#d32f2f,stroke-width:2px
    classDef storageStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    
    class SaveToStorage,CreateTask,Processing,ServeFile,LogAccess,FormatResponse storageStyle
    class Validate,ProcessingStates,DownloadReq,ExpiredCheck,AuthCheck,DeleteReq,DeleteAuth decisionStyle
    class Available,ReturnHistory,DeleteSuccess,LogAccess successStyle
    class FormatError,SizeError,Failed,AccessDenied,DeleteDenied,CleanupExpired,CleanupFailed errorStyle
```







### SSEå¼‚æ­¥æ¶æ„æŠ€æœ¯å®ç°



```mermaid
sequenceDiagram
    participant Browser as æµè§ˆå™¨
    participant Frontend as Reactå‰ç«¯
    participant TaskAPI as ä»»åŠ¡API
    participant SSEEndpoint as SSEç«¯ç‚¹
    participant SSEManager as SSEç®¡ç†å™¨<br/>(å†…å­˜Map)
    participant TaskProcessor as ä»»åŠ¡å¤„ç†å™¨<br/>(ç‹¬ç«‹è¿›ç¨‹)
    participant DB as æ•°æ®åº“
    participant ExternalSvc as å¤–éƒ¨æœåŠ¡

    Note over Browser,ExternalSvc: 1. ä»»åŠ¡æäº¤é˜¶æ®µ
    Browser->>Frontend: ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶
    Frontend->>TaskAPI: POST /api/tasks/create
    TaskAPI->>DB: åˆ›å»ºprocessing_tasksè®°å½•
    TaskAPI->>Frontend: è¿”å›{taskId, sseUrl}
    TaskAPI->>TaskProcessor: å¼‚æ­¥å¯åŠ¨å¤„ç†(å®Œå…¨ç‹¬ç«‹)
    Note over TaskProcessor: ğŸ”¥ å…³é”®ï¼šä»»åŠ¡å¤„ç†å®Œå…¨ç‹¬ç«‹äºå‰ç«¯è¿æ¥
    
    Note over Browser,ExternalSvc: 2. SSEè¿æ¥å»ºç«‹é˜¶æ®µ(å¯é€‰)
    Frontend->>SSEEndpoint: GET /api/sse/tasks/{taskId}
    SSEEndpoint->>DB: éªŒè¯ä»»åŠ¡æƒé™
    SSEEndpoint->>SSEManager: æ³¨å†Œè¿æ¥ Map.set(connectionId, controller)
    SSEEndpoint->>Frontend: å»ºç«‹EventSourceè¿æ¥
    SSEEndpoint->>Frontend: data: {type: "status_update", taskId, status: "pending"}
    
    Note over Browser,ExternalSvc: 3. å¹¶è¡Œå¤„ç†é˜¶æ®µ
    par ä»»åŠ¡å¤„ç†çº¿ç¨‹(æŒç»­è¿è¡Œ)
        Note over TaskProcessor,ExternalSvc: âœ… æ— è®ºå‰ç«¯è¿æ¥çŠ¶æ€å¦‚ä½•ï¼Œä»»åŠ¡æŒç»­å¤„ç†
        TaskProcessor->>DB: æ›´æ–°çŠ¶æ€ "processing"
        TaskProcessor->>SSEManager: pushToTask(taskId, statusEvent)
        alt æœ‰æ´»è·ƒSSEè¿æ¥
            SSEManager->>Frontend: SSEæ¨é€: status update
        else æ— æ´»è·ƒè¿æ¥
            Note over SSEManager: é™é»˜å¤„ç†ï¼ŒçŠ¶æ€å·²ä¿å­˜åˆ°DB
        end
        
        TaskProcessor->>ExternalSvc: è°ƒç”¨å¤–éƒ¨å¤„ç†æœåŠ¡
        ExternalSvc-->>TaskProcessor: è¿”å›å¤–éƒ¨taskId
        
        loop çŠ¶æ€ç›‘æ§(æŒç»­è¿›è¡Œ)
            TaskProcessor->>ExternalSvc: æŸ¥è¯¢å¤„ç†çŠ¶æ€
            TaskProcessor->>DB: æ›´æ–°è¿›åº¦åˆ°æ•°æ®åº“
            TaskProcessor->>SSEManager: pushToTask(taskId, progressEvent)
            alt æœ‰æ´»è·ƒSSEè¿æ¥
                SSEManager->>Frontend: SSEæ¨é€: progress update
            else æ— æ´»è·ƒè¿æ¥
                Note over SSEManager: è¿›åº¦å·²ä¿å­˜ï¼Œç”¨æˆ·ç¨åå¯æŸ¥è¯¢
            end
        end
        
        ExternalSvc-->>TaskProcessor: å¤„ç†å®Œæˆé€šçŸ¥
        TaskProcessor->>DB: æ›´æ–°çŠ¶æ€ "completed" + æ‰£é™¤ç§¯åˆ†
        TaskProcessor->>SSEManager: pushToTask(taskId, completedEvent)
        alt æœ‰æ´»è·ƒSSEè¿æ¥
            SSEManager->>Frontend: SSEæ¨é€: task completed
        else æ— æ´»è·ƒè¿æ¥
            Note over SSEManager: ä»»åŠ¡å®Œæˆï¼Œç»“æœå·²ä¿å­˜ï¼Œç­‰å¾…ç”¨æˆ·æŸ¥è¯¢
        end
    and SSEè¿æ¥ç®¡ç†(å¯é€‰æœåŠ¡)
        loop æ¯30ç§’
            alt è¿æ¥å­˜åœ¨
                SSEEndpoint->>Frontend: data: {type: "heartbeat"}
            end
        end
        loop æ¯åˆ†é’Ÿ
            SSEManager->>SSEManager: cleanupExpiredConnections()
            Note over SSEManager: æ¸…ç†æ–­å¼€çš„è¿æ¥ï¼Œä¸å½±å“ä»»åŠ¡å¤„ç†
        end
    end
    
    Note over Browser,ExternalSvc: 4. ç”¨æˆ·ç¦»å¼€é¡µé¢(ä»»åŠ¡ç»§ç»­)
    Browser->>Frontend: ç”¨æˆ·å…³é—­é¡µé¢/æµè§ˆå™¨
    Frontend->>SSEEndpoint: EventSource.close()
    SSEEndpoint->>SSEManager: ç§»é™¤è¿æ¥ Map.delete(connectionId)
    Note over TaskProcessor: âœ… ä»»åŠ¡å¤„ç†ç»§ç»­ï¼Œä¸å—å½±å“
    Note over DB: âœ… ä»»åŠ¡çŠ¶æ€æŒç»­æ›´æ–°åˆ°æ•°æ®åº“
    Note over ExternalSvc: âœ… å¤–éƒ¨æœåŠ¡å¤„ç†ç»§ç»­
    
    Note over Browser,ExternalSvc: 5. ç”¨æˆ·é‡æ–°è¿æ¥æŸ¥çœ‹çŠ¶æ€
    Browser->>Frontend: ç”¨æˆ·é‡æ–°æ‰“å¼€é¡µé¢
    Frontend->>TaskAPI: GET /api/tasks/{taskId}/status
    TaskAPI->>DB: æŸ¥è¯¢æœ€æ–°ä»»åŠ¡çŠ¶æ€
    TaskAPI->>Frontend: è¿”å›å½“å‰çŠ¶æ€å’Œè¿›åº¦
    alt ä»»åŠ¡å·²å®Œæˆ
        Frontend->>Browser: æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
    else ä»»åŠ¡è¿›è¡Œä¸­
        Frontend->>SSEEndpoint: é‡æ–°å»ºç«‹SSEè¿æ¥
        Note over Frontend: ç»§ç»­å®æ—¶ç›‘å¬å‰©ä½™è¿›åº¦
    end
    
    Note over Browser,ExternalSvc: 6. ç»“æœä¸‹è½½(ä»»ä½•æ—¶å€™)
    Browser->>Frontend: ç”¨æˆ·ç‚¹å‡»ä¸‹è½½
    Frontend->>TaskAPI: GET /api/tasks/{taskId}/download
    TaskAPI->>DB: éªŒè¯æƒé™å’ŒçŠ¶æ€
    alt ä»»åŠ¡å·²å®Œæˆ
        TaskAPI->>Browser: è¿”å›æ–‡ä»¶æµ
    else ä»»åŠ¡æœªå®Œæˆ
        TaskAPI->>Frontend: è¿”å›"ä»»åŠ¡å¤„ç†ä¸­"æç¤º
    end
    
    Note over Browser,ExternalSvc: ğŸ¯ å…³é”®æ¶æ„åŸåˆ™
    Note over TaskProcessor: ä»»åŠ¡å¤„ç†å™¨ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–å‰ç«¯è¿æ¥
    Note over DB: æ•°æ®åº“ä½œä¸ºçŠ¶æ€åŒæ­¥çš„å”¯ä¸€çœŸå®æ¥æº
    Note over SSEManager: SSEä»…ç”¨äºå®æ—¶æ¨é€ï¼Œæ–­å¼€ä¸å½±å“ä»»åŠ¡
    Note over TaskAPI: æ”¯æŒéšæ—¶æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ï¼Œæ”¯æŒæ–­ç‚¹ç»­è¿
```



### æ•°æ®åº“å…³ç³»





```mermaid
erDiagram
    users {
        int id PK
        string clerk_id UK "Clerkè®¤è¯ID"
        string email "ç”¨æˆ·é‚®ç®±"
        int points "ç§¯åˆ†ä½™é¢"
        boolean has_infinite_points "æ— é™ç§¯åˆ†æ ‡è¯†"
        timestamp created_at "åˆ›å»ºæ—¶é—´"
        timestamp updated_at "æ›´æ–°æ—¶é—´"
    }
    
    processing_tasks {
        int id PK
        string user_id FK "ç”¨æˆ·ID"
        string task_type "ä»»åŠ¡ç±»å‹"
        string task_status "ä»»åŠ¡çŠ¶æ€"
        int progress_percent "è¿›åº¦ç™¾åˆ†æ¯”"
        string status_message "çŠ¶æ€æ¶ˆæ¯"
        string input_filename "è¾“å…¥æ–‡ä»¶å"
        bigint input_file_size "è¾“å…¥æ–‡ä»¶å¤§å°"
        string input_storage_path "è¾“å…¥å­˜å‚¨è·¯å¾„"
        jsonb processing_params "å¤„ç†å‚æ•°"
        string external_task_id "å¤–éƒ¨ä»»åŠ¡ID"
        int estimated_points "é¢„ä¼°ç§¯åˆ†"
        int actual_points_used "å®é™…ä½¿ç”¨ç§¯åˆ†"
        string result_storage_path "ç»“æœå­˜å‚¨è·¯å¾„"
        bigint result_file_size "ç»“æœæ–‡ä»¶å¤§å°"
        string result_filename "ç»“æœæ–‡ä»¶å"
        string error_code "é”™è¯¯ä»£ç "
        string error_message "é”™è¯¯æ¶ˆæ¯"
        int retry_count "é‡è¯•æ¬¡æ•°"
        timestamp created_at "åˆ›å»ºæ—¶é—´"
        timestamp started_at "å¼€å§‹æ—¶é—´"
        timestamp completed_at "å®Œæˆæ—¶é—´"
        timestamp expires_at "è¿‡æœŸæ—¶é—´"
    }
    
    point_transactions {
        int id PK
        string user_id FK "ç”¨æˆ·ID"
        int task_id FK "å…³è”ä»»åŠ¡ID"
        int amount "ç§¯åˆ†å˜åŠ¨"
        string transaction_type "äº¤æ˜“ç±»å‹"
        string description "æè¿°"
        timestamp created_at "åˆ›å»ºæ—¶é—´"
    }
    
    user_checkins {
        int id PK
        string user_id FK "ç”¨æˆ·ID"
        date checkin_date "ç­¾åˆ°æ—¥æœŸ"
        int points_earned "è·å¾—ç§¯åˆ†"
        timestamp created_at "åˆ›å»ºæ—¶é—´"
    }
    
    redeem_codes {
        int id PK
        string code UK "å…‘æ¢ç "
        int points_value "ç§¯åˆ†ä»·å€¼"
        int max_uses "æœ€å¤§ä½¿ç”¨æ¬¡æ•°"
        int current_uses "å½“å‰ä½¿ç”¨æ¬¡æ•°"
        boolean is_active "æ˜¯å¦æ¿€æ´»"
        timestamp expires_at "è¿‡æœŸæ—¶é—´"
        timestamp created_at "åˆ›å»ºæ—¶é—´"
    }
    
    code_redemptions {
        int id PK
        int code_id FK "å…‘æ¢ç ID"
        string user_id FK "ç”¨æˆ·ID"
        int points_earned "è·å¾—ç§¯åˆ†"
        int transaction_id FK "äº¤æ˜“è®°å½•ID"
        timestamp created_at "åˆ›å»ºæ—¶é—´"
    }
    
    %% å…³ç³»å®šä¹‰
    users ||--o{ processing_tasks : "ç”¨æˆ·åˆ›å»ºä»»åŠ¡"
    users ||--o{ point_transactions : "ç”¨æˆ·ç§¯åˆ†äº¤æ˜“"
    users ||--o{ user_checkins : "ç”¨æˆ·ç­¾åˆ°è®°å½•"
    users ||--o{ code_redemptions : "ç”¨æˆ·å…‘æ¢è®°å½•"
    
    processing_tasks ||--o{ point_transactions : "ä»»åŠ¡äº§ç”Ÿäº¤æ˜“"
    
    redeem_codes ||--o{ code_redemptions : "å…‘æ¢ç è¢«ä½¿ç”¨"
    
    point_transactions ||--o| code_redemptions : "å…‘æ¢äº§ç”Ÿäº¤æ˜“"
```





