# æ™ºè¯‘å¹³å°å¼‚æ­¥æ¶æ„è®¾è®¡æ–‡æ¡£

## 1. æ¶æ„æ¦‚è¿°

æ™ºè¯‘å¹³å°é‡‡ç”¨åŸºäº Server-Sent Events (SSE) çš„å¼‚æ­¥æ¶æ„ï¼Œå®ç°äº†æ–‡æ¡£å¤„ç†æœåŠ¡çš„å®æ—¶çŠ¶æ€åé¦ˆå’Œé«˜æ•ˆå¤„ç†ã€‚è¯¥æ¶æ„è§£å†³äº†é•¿æ—¶é—´è¿è¡Œä»»åŠ¡çš„ç”¨æˆ·ä½“éªŒé—®é¢˜ï¼Œç¡®ä¿å³ä½¿åœ¨å¤„ç†å¤§å‹æ–‡ä»¶æˆ–å¤æ‚ä»»åŠ¡æ—¶ï¼Œç”¨æˆ·ä¹Ÿèƒ½è·å¾—å®æ—¶çš„è¿›åº¦æ›´æ–°å’ŒçŠ¶æ€åé¦ˆã€‚

### 1.1 æ ¸å¿ƒæ¶æ„åŸåˆ™

- **å¼‚æ­¥å¤„ç†**ï¼šæ‰€æœ‰æ–‡æ¡£å¤„ç†ä»»åŠ¡éƒ½åœ¨åå°å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ç”¨æˆ·ç•Œé¢
- **å®æ—¶åé¦ˆ**ï¼šé€šè¿‡ SSE å‘å‰ç«¯æ¨é€å®æ—¶çŠ¶æ€æ›´æ–°
- **çŠ¶æ€æŒä¹…åŒ–**ï¼šä»»åŠ¡çŠ¶æ€ä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œç¡®ä¿ç³»ç»Ÿé‡å¯æˆ–è¿æ¥æ–­å¼€åä»èƒ½æ¢å¤
- **è¿æ¥ç®¡ç†**ï¼šSSE è¿æ¥æ˜¯ä¸´æ—¶çš„æŠ€æœ¯å®ç°ï¼Œä»…åœ¨å†…å­˜ä¸­ç®¡ç†ï¼Œä¸æŒä¹…åŒ–åˆ°æ•°æ®åº“
- **ä»»åŠ¡é©±åŠ¨**ï¼šæ‰€æœ‰æ–‡ä»¶å¤„ç†æ“ä½œéƒ½åˆ›å»º processing_tasks è®°å½•å¹¶é€šè¿‡ SSE æ¨é€çŠ¶æ€

## 2. æŠ€æœ¯å®ç°

### 2.1 SSE è¿æ¥ç®¡ç†

æ™ºè¯‘å¹³å°ä½¿ç”¨ä¸¤ç§ SSE è¿æ¥ç®¡ç†å™¨ï¼š

1. **ä»»åŠ¡ SSE ç®¡ç†å™¨**ï¼šå¤„ç†ç‰¹å®šä»»åŠ¡çš„çŠ¶æ€æ›´æ–°
2. **é€šçŸ¥ SSE ç®¡ç†å™¨**ï¼šå¤„ç†å…¨å±€é€šçŸ¥æ¨é€

è¿™ä¸¤ä¸ªç®¡ç†å™¨éƒ½é‡‡ç”¨å†…å­˜ä¸­çš„ Map ç»“æ„æ¥å­˜å‚¨è¿æ¥ä¿¡æ¯ï¼Œç¡®ä¿é«˜æ•ˆçš„æ¶ˆæ¯æ¨é€å’Œè¿æ¥ç®¡ç†ã€‚

```typescript
// æ–‡ä»¶: lib/sse/connection-manager.ts
// ä»»åŠ¡çŠ¶æ€SSEè¿æ¥ç®¡ç†å™¨
class TaskSSEManager {
  private connections = new Map<string, {
    userId: string;
    taskId: number;
    controller: ReadableStreamDefaultController<Uint8Array>;
    connectionId: string;
  }>();
  
  // æ·»åŠ è¿æ¥
  addConnection(connectionId: string, userId: string, taskId: number, controller: ReadableStreamDefaultController<Uint8Array>) {
    this.connections.set(connectionId, { userId, taskId, controller, connectionId });
  }
  
  // æ¨é€çŠ¶æ€æ›´æ–°ç»™ç‰¹å®šä»»åŠ¡
  pushToTask(taskId: number, statusUpdate: { type: string; data: any }) {
    const taskConnections = Array.from(this.connections.values())
      .filter(conn => conn.taskId === taskId);
      
    // æ¨é€æ¶ˆæ¯åˆ°æ‰€æœ‰ç›¸å…³è¿æ¥
    // ...
  }
  
  // å…¶ä»–æ–¹æ³•...
}

// å¯¼å‡ºå•ä¾‹å®ä¾‹
export const sseConnectionManager = new TaskSSEManager();
```

### 2.2 ä»»åŠ¡å¤„ç†æµç¨‹

æ™ºè¯‘å¹³å°çš„ä»»åŠ¡å¤„ç†æµç¨‹ç”±ä»¥ä¸‹æ ¸å¿ƒæ–‡ä»¶å®ç°ï¼š

- **actions/tasks/task-actions.ts**: ä»»åŠ¡ç®¡ç†çš„æ ¸å¿ƒæ–‡ä»¶ï¼ŒåŒ…å«ä»»åŠ¡åˆ›å»ºã€çŠ¶æ€æ›´æ–°ã€å®Œæˆå’Œå¤±è´¥å¤„ç†ç­‰åŠŸèƒ½
- **app/api/tasks/create/route.ts**: ä»»åŠ¡åˆ›å»ºAPIç«¯ç‚¹ï¼Œå¤„ç†å‰ç«¯çš„ä»»åŠ¡åˆ›å»ºè¯·æ±‚
- **lib/processing/task-processor.ts**: ä»»åŠ¡å¤„ç†å™¨å®ç°ï¼Œè´Ÿè´£æ‰§è¡Œä»»åŠ¡å¤„ç†é€»è¾‘
- **app/api/sse/tasks/[taskId]/route.ts**: ä»»åŠ¡SSEè¿æ¥ç«¯ç‚¹ï¼Œå»ºç«‹å®æ—¶çŠ¶æ€æ¨é€é€šé“
- **app/api/tasks/webhook/route.ts**: å¤–éƒ¨æœåŠ¡å›è°ƒå¤„ç†ï¼Œæ¥æ”¶å¼‚æ­¥ä»»åŠ¡å®Œæˆé€šçŸ¥
- **lib/sse/connection-manager.ts**: SSEè¿æ¥ç®¡ç†å™¨ï¼Œç®¡ç†å‰ç«¯è¿æ¥å’Œæ¶ˆæ¯æ¨é€

æµç¨‹å¦‚ä¸‹ï¼š

1. **ä»»åŠ¡åˆ›å»º**ï¼š
   - å‰ç«¯ä¸Šä¼ æ–‡ä»¶å¹¶æäº¤å¤„ç†è¯·æ±‚
   - åç«¯éªŒè¯è¯·æ±‚å¹¶åˆ›å»ºä»»åŠ¡è®°å½•
   - è¿”å›ä»»åŠ¡ ID å’Œ SSE URL ç»™å‰ç«¯

2. **SSE è¿æ¥å»ºç«‹**ï¼š
   - å‰ç«¯ä½¿ç”¨è¿”å›çš„ SSE URL å»ºç«‹ EventSource è¿æ¥
   - åç«¯æ³¨å†Œè¿æ¥å¹¶å‘é€åˆå§‹çŠ¶æ€

3. **å¼‚æ­¥ä»»åŠ¡å¤„ç†**ï¼š
   - åç«¯å¯åŠ¨å¼‚æ­¥å¤„ç†ä»»åŠ¡
   - å¤„ç†è¿‡ç¨‹ä¸­å®šæœŸæ›´æ–°ä»»åŠ¡çŠ¶æ€å¹¶é€šè¿‡ SSE æ¨é€è¿›åº¦
   - ä»»åŠ¡å®Œæˆåæ¨é€å®ŒæˆçŠ¶æ€å’Œç»“æœä¸‹è½½é“¾æ¥

4. **æ–­çº¿å¤„ç†**ï¼š
   - ä»»åŠ¡å¤„ç†ç‹¬ç«‹äº SSE è¿æ¥ï¼Œå³ä½¿è¿æ¥æ–­å¼€ä¹Ÿç»§ç»­å¤„ç†
   - ç”¨æˆ·å¯ä»¥éšæ—¶é‡æ–°è¿æ¥å¹¶è·å–æœ€æ–°çŠ¶æ€
   - ä»»åŠ¡çŠ¶æ€æŒä¹…åŒ–åœ¨æ•°æ®åº“ä¸­ï¼Œç¡®ä¿å¯æ¢å¤æ€§

## 3. å…³é”®æŠ€æœ¯ç»„ä»¶

### 3.1 ä»»åŠ¡åˆ›å»ºä¸ç®¡ç†çš„æ ¸å¿ƒæ–‡ä»¶

æ™ºè¯‘å¹³å°ä¸­æ¶‰åŠä»»åŠ¡åˆ›å»ºå’Œç®¡ç†çš„ä¸»è¦ä»£ç æ–‡ä»¶å¦‚ä¸‹ï¼š

1. **actions/tasks/task-actions.ts**
   - ä»»åŠ¡ç®¡ç†çš„æ ¸å¿ƒæ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰ä»»åŠ¡ç›¸å…³çš„æœåŠ¡å™¨ç«¯æ“ä½œ
   - ä¸»è¦åŠŸèƒ½ï¼š
     - `createProcessingTask`: åˆ›å»ºæ–°ä»»åŠ¡ï¼Œè®¡ç®—å¹¶æ‰£é™¤ç§¯åˆ†
     - `getUserTasks`: è·å–ç”¨æˆ·çš„ä»»åŠ¡åˆ—è¡¨
     - `getTaskById`: æ ¹æ®IDè·å–ä»»åŠ¡è¯¦æƒ…
     - `updateTaskStatus`: æ›´æ–°ä»»åŠ¡çŠ¶æ€å’Œè¿›åº¦
     - `completeTask`: å®Œæˆä»»åŠ¡å¹¶å¤„ç†ç»“æœ
     - `failTask`: å¤„ç†ä»»åŠ¡å¤±è´¥é€»è¾‘ï¼Œè¿”è¿˜ç§¯åˆ†
     - `deleteTask`: åˆ é™¤ä»»åŠ¡è®°å½•

2. **app/api/tasks/create/route.ts**
   - å¤„ç†å‰ç«¯çš„ä»»åŠ¡åˆ›å»ºè¯·æ±‚
   - ä¸»è¦åŠŸèƒ½ï¼š
     - éªŒè¯ç”¨æˆ·æƒé™å’Œè¯·æ±‚å‚æ•°
     - è°ƒç”¨`createProcessingTask`åˆ›å»ºä»»åŠ¡
     - å¼‚æ­¥å¯åŠ¨ä»»åŠ¡å¤„ç†
     - è¿”å›ä»»åŠ¡IDå’ŒSSEè¿æ¥URLç»™å‰ç«¯

3. **lib/processing/task-processor.ts**
   - è´Ÿè´£å®é™…æ‰§è¡Œä»»åŠ¡å¤„ç†é€»è¾‘çš„æ ¸å¿ƒç±»
   - ä¸»è¦åŠŸèƒ½ï¼š
     - `processTask`: å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶ä»»åŠ¡
     - `processTaskFromPath`: ä»æ–‡ä»¶è·¯å¾„å¤„ç†ä»»åŠ¡
     - `completeExternalTask`: å®Œæˆå¤–éƒ¨å¼‚æ­¥ä»»åŠ¡
     - `downloadResult`: ä¸‹è½½å¹¶ä¿å­˜å¤„ç†ç»“æœ
     - `saveResultFile`: å°†ç»“æœä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿ

4. **app/api/tasks/webhook/route.ts**
   - å¤„ç†å¤–éƒ¨æœåŠ¡çš„å¼‚æ­¥ä»»åŠ¡å®Œæˆå›è°ƒ
   - ä¸»è¦åŠŸèƒ½ï¼š
     - æ¥æ”¶å¤–éƒ¨ä»»åŠ¡çŠ¶æ€æ›´æ–°
     - æ ¹æ®å¤–éƒ¨ä»»åŠ¡IDæŸ¥æ‰¾å†…éƒ¨ä»»åŠ¡
     - å¤„ç†ä»»åŠ¡å®Œæˆæˆ–å¤±è´¥é€»è¾‘

### 3.2 SSE ç«¯ç‚¹å®ç°

```typescript
// æ–‡ä»¶: app/api/sse/tasks/[taskId]/route.ts
// ä»»åŠ¡SSEç«¯ç‚¹å®ç°
export async function GET(request: NextRequest, { params }: { params: { taskId: string } }) {
  try {
    const { userId } = auth();
    
    if (!userId) {
      return NextResponse.json(
        { success: false, message: "ç”¨æˆ·æœªè®¤è¯" },
        { status: 401 }
      );
    }

    const taskId = parseInt(params.taskId);
    
    // éªŒè¯ä»»åŠ¡æƒé™å¹¶è·å–å½“å‰çŠ¶æ€
    const taskResult = await getTaskById(taskId);
    if (!taskResult.success || !taskResult.task) {
      return NextResponse.json(
        { success: false, message: "ä»»åŠ¡ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®" },
        { status: 404 }
      );
    }

    // åˆ›å»ºSSEæµ
    const stream = new ReadableStream({
      async start(controller) {
        const connectionId = generateRandomString(16);
        
        // æ³¨å†ŒSSEè¿æ¥
        sseConnectionManager.addConnection(connectionId, userId, taskId, controller);
        
        // å‘é€åˆå§‹çŠ¶æ€
        const initialMessage = {
          type: "status_update",
          data: {
            taskId: taskId,
            status: taskResult.task.taskStatus,
            progress: taskResult.task.progressPercent || 0,
            message: taskResult.task.statusMessage || '',
          }
        };
        
        // è®¾ç½®è¿æ¥å…³é—­å¤„ç†
        request.signal.addEventListener('abort', () => {
          sseConnectionManager.removeConnection(connectionId);
        });
      },
    });
    
    return new NextResponse(stream, {
      headers: {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive',
      },
    });
  } catch (error) {
    console.error("ä»»åŠ¡SSEè¿æ¥é”™è¯¯:", error);
    return NextResponse.json(
      { success: false, message: "å»ºç«‹ä»»åŠ¡SSEè¿æ¥å¤±è´¥" },
      { status: 500 }
    );
  }
}
```

### 3.2 ä»»åŠ¡å¤„ç†å™¨

```typescript
// æ–‡ä»¶: lib/processing/task-processor.ts
// ä»»åŠ¡å¤„ç†å™¨æ ¸å¿ƒç±»
export class TaskProcessor {
  private taskId: number;
  private userId: string;
  private taskType: TaskType;
  private externalTaskId?: string;

  constructor(taskId: number, userId: string, taskType: TaskType, externalTaskId?: string) {
    this.taskId = taskId;
    this.userId = userId;
    this.taskType = taskType;
    this.externalTaskId = externalTaskId;
  }

  // æ¨é€SSEçŠ¶æ€æ›´æ–°
  private async pushStatusUpdate(status: string, progress: number, message?: string) {
    // æ›´æ–°æ•°æ®åº“çŠ¶æ€
    await updateTaskStatus(this.taskId, status, progress, message);
    
    // æ¨é€SSEæ¶ˆæ¯
    sseConnectionManager.pushToTask(this.taskId, {
      type: 'status_update',
      data: { status, progress, message }
    });
  }
  
  // å¤„ç†ä»»åŠ¡
  async processTaskFromPath<T extends TaskType>(filePath: string, params: TaskParams[T]): Promise<void> {
    try {
      console.log(`ğŸš€ [${this.taskId}] å¼€å§‹å¤„ç†ä»»åŠ¡ï¼Œç±»å‹: ${this.taskType}`);
      
      // æ›´æ–°çŠ¶æ€ä¸ºå¤„ç†ä¸­
      await this.pushStatusUpdate('processing', 0, 'å¼€å§‹å¤„ç†...');
      
      // ä»å­˜å‚¨è·¯å¾„è¯»å–æ–‡ä»¶
      const { readFile } = await import('fs/promises');
      const { join } = await import('path');
      
      // æ„å»ºå®Œæ•´æ–‡ä»¶è·¯å¾„
      const dataStoragePath = process.env.DATA_STORAGE_PATH || './data';
      const fullPath = join(dataStoragePath, filePath, 'original');
      
      // å¤„ç†ä»»åŠ¡é€»è¾‘
      // ...
      
      // å®šæœŸæ›´æ–°è¿›åº¦
      await this.pushStatusUpdate('processing', 50, 'å¤„ç†ä¸­...');
      
      // å®Œæˆå¤„ç†
      await this.pushStatusUpdate('completed', 100, 'å¤„ç†å®Œæˆ');
    } catch (error) {
      // å¤„ç†å¤±è´¥
      console.error(`âŒ [${this.taskId}] ä»è·¯å¾„å¤„ç†ä»»åŠ¡å¤±è´¥:`, error);
      await this.pushStatusUpdate('failed', 0, error.message);
    }
  }
}
```

### 3.3 å‰ç«¯å®ç°

```typescript
// æ–‡ä»¶: app/[åŠŸèƒ½æ¨¡å—]/_components/task-processor.tsx
// å‰ç«¯SSEè¿æ¥å®ç°
import { useEffect, useState } from 'react';

export function useTaskStatus(taskId: number) {
  const [status, setStatus] = useState('pending');
  const [progress, setProgress] = useState(0);
  const [message, setMessage] = useState('');
  const [error, setError] = useState<string | null>(null);
  
  useEffect(() => {
    if (!taskId) return;
    
    // æ„å»ºSSE URL
    const sseUrl = `/api/sse/tasks/${taskId}`;
    const eventSource = new EventSource(sseUrl);
    
    eventSource.onopen = () => {
      console.log('âœ… SSEè¿æ¥å·²å»ºç«‹');
    };
    
    eventSource.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        
        if (data.type === 'status_update') {
          setStatus(data.data.status);
          setProgress(data.data.progress || 0);
          setMessage(data.data.message || '');
          
          if (data.data.status === 'failed') {
            setError(data.data.message || 'å¤„ç†å¤±è´¥');
          }
        }
      } catch (error) {
        console.error('SSEæ¶ˆæ¯è§£æå¤±è´¥:', error);
      }
    };
    
    eventSource.onerror = () => {
      console.error('SSEè¿æ¥é”™è¯¯');
      eventSource.close();
    };
    
    // æ¸…ç†å‡½æ•°
    return () => {
      eventSource.close();
    };
  }, [taskId]);
  
  return { status, progress, message, error };
}
```

## 4. å¼‚æ­¥æ¶æ„ä¼˜åŠ¿

### 4.1 ç”¨æˆ·ä½“éªŒæå‡

- **å®æ—¶åé¦ˆ**ï¼šç”¨æˆ·æ— éœ€åˆ·æ–°é¡µé¢å³å¯è·å–ä»»åŠ¡è¿›åº¦å’ŒçŠ¶æ€
- **æ–­ç‚¹ç»­è¿**ï¼šå³ä½¿ç”¨æˆ·æš‚æ—¶ç¦»å¼€é¡µé¢ï¼Œä»»åŠ¡ä»åœ¨åå°å¤„ç†ï¼Œè¿”å›åå¯ç»§ç»­æŸ¥çœ‹è¿›åº¦
- **å¤šä»»åŠ¡å¹¶è¡Œ**ï¼šç”¨æˆ·å¯ä»¥åŒæ—¶æäº¤å¤šä¸ªä»»åŠ¡ï¼Œç³»ç»Ÿèƒ½å¹¶è¡Œå¤„ç†å¹¶æ¨é€å„è‡ªçš„çŠ¶æ€

### 4.2 ç³»ç»Ÿæ•ˆç‡æå‡

- **èµ„æºä¼˜åŒ–**ï¼šé•¿æ—¶é—´ä»»åŠ¡ä¸å ç”¨å‰ç«¯èµ„æºï¼Œé¿å…æµè§ˆå™¨è¶…æ—¶
- **è´Ÿè½½åˆ†æ•£**ï¼šä»»åŠ¡å¤„ç†ä¸ç”¨æˆ·ç•Œé¢åˆ†ç¦»ï¼Œç³»ç»Ÿè´Ÿè½½æ›´å‡è¡¡
- **å¯æ‰©å±•æ€§**ï¼šå¤„ç†é€»è¾‘ä¸å‰ç«¯è§£è€¦ï¼Œä¾¿äºæ¨ªå‘æ‰©å±•å¤„ç†èƒ½åŠ›

### 4.3 å¯é æ€§æå‡

- **çŠ¶æ€æŒä¹…åŒ–**ï¼šä»»åŠ¡çŠ¶æ€ä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œç³»ç»Ÿé‡å¯ä¸å½±å“ä»»åŠ¡æ¢å¤
- **é”™è¯¯éš”ç¦»**ï¼šå•ä¸ªä»»åŠ¡å¤±è´¥ä¸å½±å“å…¶ä»–ä»»åŠ¡æˆ–ç”¨æˆ·ä½“éªŒ
- **é‡è¯•æœºåˆ¶**ï¼šæ”¯æŒå¤±è´¥ä»»åŠ¡çš„è‡ªåŠ¨æˆ–æ‰‹åŠ¨é‡è¯•

## 5. ä»»åŠ¡åˆ›å»ºä¸ç®¡ç†çš„å®Œæ•´æµç¨‹

æ™ºè¯‘å¹³å°çš„ä»»åŠ¡åˆ›å»ºä¸ç®¡ç†æµç¨‹å¦‚ä¸‹ï¼š

1. **ä»»åŠ¡åˆ›å»º** (æ–‡ä»¶: app/api/tasks/create/route.ts)
   - å‰ç«¯è°ƒç”¨ `/api/tasks/create` API
   - `app/api/tasks/create/route.ts` æ¥æ”¶è¯·æ±‚å¹¶éªŒè¯å‚æ•°
   - è°ƒç”¨ `actions/tasks/task-actions.ts` ä¸­çš„ `createProcessingTask` åˆ›å»ºä»»åŠ¡è®°å½•
   - å¼‚æ­¥å¯åŠ¨ `processTaskAsync` å¤„ç†ä»»åŠ¡
   - è¿”å›ä»»åŠ¡IDå’ŒSSE URLç»™å‰ç«¯

2. **ä»»åŠ¡å¤„ç†** (æ–‡ä»¶: lib/processing/task-processor.ts)
   - `TaskProcessor` ç±»å¤„ç†ä»»åŠ¡
   - æ ¹æ®ä»»åŠ¡ç±»å‹è°ƒç”¨ç›¸åº”çš„å¤„ç†é€»è¾‘
   - é€šè¿‡ `pushStatusUpdate` æ–¹æ³•æ›´æ–°ä»»åŠ¡çŠ¶æ€å’Œè¿›åº¦
   - å¯¹äºå¼‚æ­¥ä»»åŠ¡ï¼Œç­‰å¾…å¤–éƒ¨æœåŠ¡é€šè¿‡webhookå›è°ƒ

3. **çŠ¶æ€ç›‘æ§** (æ–‡ä»¶: app/api/sse/tasks/[taskId]/route.ts)
   - å‰ç«¯é€šè¿‡ `/api/sse/tasks/[taskId]` å»ºç«‹SSEè¿æ¥
   - éªŒè¯æƒé™å¹¶å»ºç«‹è¿æ¥
   - `lib/sse/connection-manager.ts` ç®¡ç†è¿æ¥å¹¶æ¨é€çŠ¶æ€æ›´æ–°
   - ä»»åŠ¡çŠ¶æ€å˜åŒ–æ—¶å®æ—¶æ¨é€åˆ°å‰ç«¯

4. **ä»»åŠ¡å®Œæˆ**
   - åŒæ­¥ä»»åŠ¡ï¼šç›´æ¥å¤„ç†ç»“æœå¹¶æ›´æ–°çŠ¶æ€
   - å¼‚æ­¥ä»»åŠ¡ï¼šé€šè¿‡ `app/api/tasks/webhook/route.ts` æ¥æ”¶å¤–éƒ¨æœåŠ¡å›è°ƒ
   - è°ƒç”¨ `actions/tasks/task-actions.ts` ä¸­çš„ `completeTask` å®Œæˆä»»åŠ¡
   - é€šè¿‡SSEæ¨é€å®ŒæˆçŠ¶æ€åˆ°å‰ç«¯

5. **é”™è¯¯å¤„ç†** (æ–‡ä»¶: actions/tasks/task-actions.ts)
   - ä»»åŠ¡å¤±è´¥æ—¶è°ƒç”¨ `failTask` æ–¹æ³•
   - è¿”è¿˜é¢„æ‰£çš„ç§¯åˆ†
   - è®°å½•é”™è¯¯ä¿¡æ¯å¹¶é€šè¿‡SSEæ¨é€åˆ°å‰ç«¯

## 6. æ¶æ„æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ

### 6.1 è¿æ¥ç®¡ç†

**æŒ‘æˆ˜**ï¼šå¤§é‡å¹¶å‘è¿æ¥å¯èƒ½å¯¼è‡´å†…å­˜å ç”¨è¿‡é«˜
**è§£å†³æ–¹æ¡ˆ**ï¼š
- å®ç°è¿æ¥è¶…æ—¶æœºåˆ¶ï¼Œè‡ªåŠ¨æ¸…ç†é•¿æ—¶é—´æ— æ´»åŠ¨çš„è¿æ¥
- å®šæœŸå‘é€å¿ƒè·³æ¶ˆæ¯ä¿æŒè¿æ¥æ´»è·ƒ
- å®ç°è¿æ¥æ•°é™åˆ¶å’Œè´Ÿè½½å‡è¡¡ç­–ç•¥

### 6.2 çŠ¶æ€ä¸€è‡´æ€§

**æŒ‘æˆ˜**ï¼šç¡®ä¿æ•°æ®åº“çŠ¶æ€ä¸æ¨é€ç»™ç”¨æˆ·çš„çŠ¶æ€ä¸€è‡´
**è§£å†³æ–¹æ¡ˆ**ï¼š
- å…ˆæ›´æ–°æ•°æ®åº“å†æ¨é€æ¶ˆæ¯
- å®ç°äº‹åŠ¡æœºåˆ¶ç¡®ä¿çŠ¶æ€æ›´æ–°çš„åŸå­æ€§
- å®šæœŸåŒæ­¥æœºåˆ¶ä¿®å¤å¯èƒ½çš„ä¸ä¸€è‡´çŠ¶æ€

### 6.3 é”™è¯¯å¤„ç†

**æŒ‘æˆ˜**ï¼šå¼‚æ­¥ä»»åŠ¡çš„é”™è¯¯éš¾ä»¥è¿½è¸ªå’Œå¤„ç†
**è§£å†³æ–¹æ¡ˆ**ï¼š
- å®Œå–„çš„æ—¥å¿—è®°å½•ç³»ç»Ÿ
- é”™è¯¯çŠ¶æ€æŒä¹…åŒ–åˆ°æ•°æ®åº“
- é€šè¿‡ SSE å®æ—¶æ¨é€é”™è¯¯ä¿¡æ¯ç»™ç”¨æˆ·
- å®ç°ç›‘æ§å‘Šè­¦æœºåˆ¶
